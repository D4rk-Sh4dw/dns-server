version: '3.8'

services:
  # --- Central Management Dashboard ---
  dashboard:
    image: ghcr.io/d4rk-sh4dw/dns-frontend:latest
    # build: ./frontend
    container_name: dns-dashboard
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - ADGUARD_URL=http://dns-adguard:3000
      - ADGUARD_USER=admin
      - ADGUARD_PASS=admin123
      - TECHNITIUM_URL=http://dns-technitium:5380
      - TECHNITIUM_TOKEN=auto # Will be fetched on first run
    depends_on:
      adguard:
        condition: service_healthy
      technitium:
        condition: service_healthy
    networks:
      - dns-management-net

  # --- AdGuard Home (Recursive DNS & AdBlocking) ---
  adguard:
    image: adguard/adguardhome:latest
    container_name: dns-adguard
    restart: unless-stopped
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "3001:3000/tcp" # AdGuard Web Interface (port 3000 inside container)
    volumes:
      - ./data/adguard/work:/opt/adguardhome/work
      - ./config/adguard:/opt/adguardhome/conf
    networks:
      - dns-management-net
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:3000/control/status" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # --- Technitium DNS (Authoritative DNS) ---
  technitium:
    image: technitium/dns-server:latest
    container_name: dns-technitium
    restart: unless-stopped
    ports:
      - "5380:5380/tcp"
      - "5353:53/udp" # Secondary DNS port for internal queries from AdGuard
      - "5353:53/tcp"
    environment:
      - DNS_SERVER_DOMAIN=dns.local
      - DNS_SERVER_ADMIN_PASSWORD=admin123
      - DNS_SERVER_PREFER_IPV6=false
    volumes:
      - ./data/technitium:/etc/dns
    networks:
      - dns-management-net
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:5380/" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

networks:
  dns-management-net:
    driver: bridge
